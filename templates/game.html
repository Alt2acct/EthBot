<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ app_name }} â€” Aviator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a32;
      --muted: #7a8cb2;
      --accent: #7dd3fc;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; }
    body { background: radial-gradient(1200px 600px at 50% -10%, #19224a 0%, var(--bg) 60%); color: #e5e7eb; }
    .wrap { max-width: 440px; margin: 18px auto; padding: 12px; }
    .card { background: linear-gradient(180deg, #141a31, #0f152a); border: 1px solid #243055; border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .title { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px; }
    .title .badge { padding: 4px 8px; border: 1px solid #2c3a66; border-radius: 999px; color: var(--muted); font-size: 12px;}
    .meter { margin: 14px 0 10px; height: 74px; background: #0d1328; border:1px solid #263157; border-radius: 14px; position: relative; overflow: hidden; }
    .mult { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 42px; font-weight: 800; text-shadow: 0 6px 22px rgba(0,0,0,.5); }
    .flight { position:absolute; left: -48px; top: 50%; width: 40px; height: 40px; transform: translateY(-50%); transition: transform 80ms linear; }
    .plane { width: 40px; height: 40px; background: radial-gradient(circle at 40% 40%, #60a5fa, #2563eb); border-radius: 6px; transform: rotate(35deg); box-shadow: 0 6px 16px rgba(37,99,235,.5); }
    .row { display:flex; gap:10px; margin-top: 12px; }
    .col { flex: 1; }
    .input { width: 100%; background: #0b1127; border: 1px solid #2a365f; color: #e5e7eb; padding: 12px 12px; border-radius: 12px; font-size: 16px; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .btn { width: 100%; appearance: none; border: 0; padding: 12px 14px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: transform .02s ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(180deg, #38bdf8, #0ea5e9); color: #071427; }
    .btn-warn { background: linear-gradient(180deg, #fde047, #f59e0b); color: #3a2a03; }
    .btn-danger { background: linear-gradient(180deg, #fda4af, #ef4444); color: #34080a; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; background:#0d1531; border:1px solid #263157; border-radius:999px; font-size:12px; color:var(--muted); }
    .stack { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .muted { color: var(--muted); }
    .hint { margin-top:8px; font-size: 12px; color: var(--muted); text-align:center; }
    .log { margin-top: 12px; padding: 10px; background:#0b1127; border:1px dashed #2a365f; border-radius: 12px; font-size: 13px; min-height: 36px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <div style="font-size:20px">{{ app_name }}</div>
        <div class="badge">Aviator â€¢ Crash Game</div>
      </div>

      <div class="meter">
        <div id="plane" class="flight"><div class="plane"></div></div>
        <div id="mult" class="mult">1.00x</div>
      </div>

      <div class="stack">
        <div class="pill">Balance: <span id="balance">â€”</span></div>
        <div class="pill">Min {{ '%.2f' % min_bet }} â€¢ Max {{ '%.2f' % max_bet }}</div>
      </div>

      <div class="row">
        <div class="col">
          <input id="bet" class="input" type="number" step="0.01" min="{{ '%.2f' % min_bet }}" max="{{ '%.2f' % max_bet }}" placeholder="Enter bet amount" />
          <div class="sub">Enter how much you want to bet</div>
        </div>
      </div>

      <div class="row">
        <div class="col"><button id="btn-start" class="btn btn-primary">Start</button></div>
        <div class="col"><button id="btn-cashout" class="btn btn-warn" disabled>Cash Out</button></div>
        <div class="col"><button id="btn-stop" class="btn btn-danger" disabled>Reset</button></div>
      </div>

      <div id="log" class="log"></div>
      <div class="hint">Pro tip: Cash out <b>before</b> the crash. House edge: 2% on profit.</div>
    </div>
  </div>

  <script>
    const chatId = "{{ chat_id }}";
    const token = "{{ token }}";
    let sessionId = null;
    let startedAt = null;
    let running = false;
    let crashed = false;
    let tickTimer = null;
    let lastMultiplier = 1.00;

    const multEl = document.getElementById('mult');
    const planeEl = document.getElementById('plane');
    const betEl = document.getElementById('bet');
    const startBtn = document.getElementById('btn-start');
    const cashoutBtn = document.getElementById('btn-cashout');
    const stopBtn = document.getElementById('btn-stop');
    const logEl = document.getElementById('log');
    const balEl = document.getElementById('balance');

    let localBalance = "â€”";
    function setBalance(x){ balEl.textContent = x; }

    function log(msg) {
      logEl.textContent = msg;
    }

    function setUIIdle() {
      running = false;
      crashed = false;
      sessionId = null;
      startBtn.disabled = false;
      cashoutBtn.disabled = true;
      stopBtn.disabled = true;
      multEl.textContent = "1.00x";
      planeEl.style.transform = "translateY(-50%) translateX(0px) rotate(0deg)";
    }

    function setUIRunning() {
      running = true;
      crashed = false;
      startBtn.disabled = true;
      cashoutBtn.disabled = false;
      stopBtn.disabled = true;
    }

    function setUICrashed() {
      running = false;
      crashed = true;
      startBtn.disabled = true;
      cashoutBtn.disabled = true;
      stopBtn.disabled = false;
    }

    async function startGame() {
      const bet = parseFloat(betEl.value);
      if (!bet || bet <= 0) {
        log("Enter a valid bet.");
        return;
      }
      log("Starting...");
      const resp = await fetch("/api/game/start", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ chat_id: chatId, token, bet })
      });
      const data = await resp.json();
      if (!data.ok) {
        log(data.error || "Failed to start");
        return;
      }
      // optimistic balance update: will refresh on result too
      setUIRunning();
      sessionId = data.session_id;
      startedAt = new Date(data.started_at);
      log("Round started. Good luck!");
      // poll status
      loop();
    }

    async function pollStatus() {
      if (!sessionId) return;
      const url = `/api/game/status?chat_id=${encodeURIComponent(chatId)}&token=${encodeURIComponent(token)}&session_id=${sessionId}`;
      const resp = await fetch(url);
      const data = await resp.json();
      if (!data.ok) {
        log(data.error || "Error");
        return;
      }
      lastMultiplier = data.multiplier;
      multEl.textContent = `${lastMultiplier.toFixed(2)}x`;
      const progressX = Math.min(260, Math.max(0, (lastMultiplier - 1) * 40));
      planeEl.style.transform = `translateY(-50%) translateX(${progressX}px) rotate(35deg)`;
      if (data.status === "won") {
        setUIIdle();
        log(`âœ… Cashed out at ${data.multiplier.toFixed(2)}x. New balance: ${data.balance}`);
        setBalance(data.balance);
      } else if (data.crashed || data.status === "lost") {
        setUICrashed();
        log(`ðŸ’¥ Crashed at ${data.crash_point.toFixed(2)}x. You lost the bet. Balance: ${data.balance || "â€”"}`);
      }
    }

    function loop() {
      clearInterval(tickTimer);
      tickTimer = setInterval(pollStatus, 150);
    }

    async function cashOut() {
      if (!sessionId) return;
      cashoutBtn.disabled = true;
      const resp = await fetch("/api/game/cashout", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ chat_id: chatId, token, session_id: sessionId })
      });
      const data = await resp.json();
      if (!data.ok) {
        log(data.error || "Cashout failed");
        cashoutBtn.disabled = false;
        return;
      }
      if (data.result === "won") {
        setUIIdle();
        log(`âœ… Cashed out at ${parseFloat(data.multiplier).toFixed(2)}x. Payout: ${data.payout}. Balance: ${data.balance}`);
        setBalance(data.balance);
      } else if (data.result === "lost") {
        setUICrashed();
        log(`ðŸ’¥ Round already crashed at ${parseFloat(data.crashed_at).toFixed(2)}x. Bet lost.`);
      }
    }

    function resetRound() {
      setUIIdle();
      log("Ready for next round.");
    }

    startBtn.addEventListener("click", startGame);
    cashoutBtn.addEventListener("click", cashOut);
    stopBtn.addEventListener("click", resetRound);

    // Initialize
    setUIIdle();
    log("Enter your bet and press Start.");
  </script>
</body>
</html>
